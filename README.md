# Микросеврис для предложения цен 1000 SKU товаров по запросам пользователей. Задача максимизации продаж с максимальной маржой.

- Разработан микросервисный клиент, который для связки `[dates, user_id, SKU]` предлагает цену `price`. Сервис `price_service.ipynb` работает по следующему алгоритму:
        1. GET запрос получает данные от сервера `[dates, user_id, SKU]`
        1. Выбирается цена запрошенного SKU товара для каждого пользователя `price`
        1. POST ответ публикует предложенные цены 
        1. Факт покупок `bought` сервис получает GET запросом и с помощью метода `update_reward` осуществляется настройка функции подбора цен для каждого `user_id` 
- Сервис посредством алгоритма многоруких бандитов `MultiArmBandit` для каждого `user_id` пользователя осуществляет подбор цены в соответствии с максимальной прибылью. Выбор цен осуществляется из дискретного диапазона цен для каждого `SKU` товара, рассчитанного на каждую неделю. Цена варьируется в соответствии 5, 50 и 95 перцентилем наценки `markup`
- Для предсказания диапазона цен был использован следующий пайплайн `price_predictions.ipynb`:
    1. Для каждого `SKU` товара были обучены квантильные LSTM модели `SKU_LSTM_quantille` на данных кол-ва покупок `num_purchase`. Т.е. были получены модели способные предсказать диапазон спроса. 
    1. Для каждой единицы товара `SKU` так же были построены квантильные регрессии `QuantileRegressionModel` описывающие связь спроса (кол-во покупок) `num_purchase` и наценки `markup` на единицу товара `SKU`.  
    1. Зная стоимость закупки на целевые даты (декабрь 2019 года) были предсказаны дискретные диапазон цен на каждый SKU товар.
    1. Т.е. на каждую неделю декабря, для каждого товара `SKU`, было предсказан 5, 50, 95 перцентиль кол-ва покупок, на основании кол-ва покупок найдены 5, 50, 95 перцентиль наценки на товар, из дискретного диапазона наценок и стоимости закупок на декабрь был найден диапазон цены на каждый товар `[price_pred_q5', price_pred_q50, price_pred_q95]`.
    
Примечания:
- В качестве стратегии для многоруких бандитов был выбран эпсилон-жадный алгоритм обучения `EpsGreedy(Strategy)`.
- При проведении EDA каждый из 1000 `SKU` был кластеризован с помощью алгоритма DBSCAN. Кластеризация происходила на основании эмбеддингов временных рядов цен. Результат кластеризации не был применен для обучения, однако использовался при визуализации.
- Для построения квантильных LSTM моделей был осуществлен поиск длинны временных окон `SKU_lag[SKU]`. Поиск и подбор осуществлялся с помощью автокорреляционной функции. Подходящим лагом считалось окно, при котором модуль автокорреляционной функции был менее 0.1 / кол-во отсчетов.
- Данные по праздничным дням `df_holidays` использовались исключительно при визуализации.
- Для `SKU` для которых не удалось построить LSTM квантильные регрессии `SKUs_remain` наценки были получены усреднением наценок за известный период
- При обучении моделей квантильной LSTM модели метрикой качества обучения служил коэффициент Intersection Over Union - отношение площади пересечения предсказанного и истинного диапазона кол-ва покупок `num_purchase` к  площади фигуры описывающей эти диапазоны. Причем истинный диапазон = истинное значение +- корень из стандартного отклонения кол-ва покупок конкретного `SKU` за тренировочный период.
